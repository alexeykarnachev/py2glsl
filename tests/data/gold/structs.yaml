- name: struct_basic
  python: |
    @dataclass
    class Point:
        x: "float"
        y: "float"

    def shader(ctx: ShaderContext) -> vec4:
        p = Point(1.0, 2.0)
        return vec4(p.x, p.y, 0.0, 1.0)
  expected: |
    #version 460 core

    struct Point {
        float x;
        float y;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Point p = Point(1.0, 2.0);
        return vec4(p.x, p.y, 0.0, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_vector_fields
  python: |
    @dataclass
    class Ray:
        origin: "vec3"
        direction: "vec3"

    def shader(ctx: ShaderContext) -> vec4:
        ray = Ray(vec3(0.0, 0.0, 0.0), vec3(0.0, 0.0, 1.0))
        return vec4(ray.direction, 1.0)
  expected: |
    #version 460 core

    struct Ray {
        vec3 origin;
        vec3 direction;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Ray ray = Ray(vec3(0.0, 0.0, 0.0), vec3(0.0, 0.0, 1.0));
        return vec4(ray.direction, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_nested
  python: |
    @dataclass
    class Inner:
        value: "float"

    @dataclass
    class Outer:
        inner: "Inner"
        scale: "float"

    def shader(ctx: ShaderContext) -> vec4:
        o = Outer(Inner(1.0), 2.0)
        return vec4(o.inner.value * o.scale, 0.0, 0.0, 1.0)
  expected: |
    #version 460 core

    struct Inner {
        float value;
    };

    struct Outer {
        Inner inner;
        float scale;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Outer o = Outer(Inner(1.0), 2.0);
        return vec4(o.inner.value * o.scale, 0.0, 0.0, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_multiple
  python: |
    @dataclass
    class Position:
        x: "float"
        y: "float"
        z: "float"

    @dataclass
    class Color:
        r: "float"
        g: "float"
        b: "float"

    def shader(ctx: ShaderContext) -> vec4:
        pos = Position(1.0, 2.0, 3.0)
        col = Color(0.5, 0.6, 0.7)
        return vec4(col.r, col.g, col.b, 1.0)
  expected: |
    #version 460 core

    struct Position {
        float x;
        float y;
        float z;
    };

    struct Color {
        float r;
        float g;
        float b;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Position pos = Position(1.0, 2.0, 3.0);
        Color col = Color(0.5, 0.6, 0.7);
        return vec4(col.r, col.g, col.b, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_field_mutation
  python: |
    @dataclass
    class Point:
        x: "float"
        y: "float"

    def shader(ctx: ShaderContext) -> vec4:
        p = Point(0.0, 0.0)
        p.x = 1.0
        p.y = 2.0
        return vec4(p.x, p.y, 0.0, 1.0)
  expected: |
    #version 460 core

    struct Point {
        float x;
        float y;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Point p = Point(0.0, 0.0);
        p.x = 1.0;
        p.y = 2.0;
        return vec4(p.x, p.y, 0.0, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_func_param
  python: |
    @dataclass
    class Material:
        color: "vec3"
        roughness: "float"

    def get_brightness(mat: "Material") -> "float":
        return (mat.color.x + mat.color.y + mat.color.z) / 3.0

    def shader(ctx: ShaderContext) -> vec4:
        mat = Material(vec3(1.0, 0.5, 0.0), 0.5)
        b = get_brightness(mat)
        return vec4(b, b, b, 1.0)
  expected: |
    #version 460 core

    struct Material {
        vec3 color;
        float roughness;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    float get_brightness(Material mat) {
        return (mat.color.x + mat.color.y + mat.color.z) / 3.0;
    }

    vec4 shader() {
        Material mat = Material(vec3(1.0, 0.5, 0.0), 0.5);
        float b = get_brightness(mat);
        return vec4(b, b, b, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_func_return
  python: |
    @dataclass
    class Material:
        color: "vec3"
        roughness: "float"

    def create_material() -> "Material":
        return Material(vec3(1.0, 0.0, 0.0), 0.5)

    def shader(ctx: ShaderContext) -> vec4:
        mat = create_material()
        return vec4(mat.color, 1.0)
  expected: |
    #version 460 core

    struct Material {
        vec3 color;
        float roughness;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    Material create_material() {
        return Material(vec3(1.0, 0.0, 0.0), 0.5);
    }

    vec4 shader() {
        Material mat = create_material();
        return vec4(mat.color, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_field_chain
  python: |
    @dataclass
    class Material:
        color: "vec3"
        roughness: "float"

    def shader(ctx: ShaderContext) -> vec4:
        mat = Material(vec3(1.0, 0.5, 0.25), 0.5)
        return vec4(mat.color.x, mat.color.y, mat.color.z, 1.0)
  expected: |
    #version 460 core

    struct Material {
        vec3 color;
        float roughness;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Material mat = Material(vec3(1.0, 0.5, 0.25), 0.5);
        return vec4(mat.color.x, mat.color.y, mat.color.z, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_field_swizzle
  python: |
    @dataclass
    class Ray:
        origin: "vec3"
        direction: "vec3"

    def shader(ctx: ShaderContext) -> vec4:
        ray = Ray(vec3(1.0, 2.0, 3.0), vec3(0.0, 1.0, 0.0))
        return vec4(ray.origin.xy, ray.direction.z, 1.0)
  expected: |
    #version 460 core

    struct Ray {
        vec3 origin;
        vec3 direction;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Ray ray = Ray(vec3(1.0, 2.0, 3.0), vec3(0.0, 1.0, 0.0));
        return vec4(ray.origin.xy, ray.direction.z, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_in_loop
  python: |
    @dataclass
    class Accumulator:
        sum: "float"
        count: "int"

    def shader(ctx: ShaderContext) -> vec4:
        acc = Accumulator(0.0, 0)
        for i in range(5):
            acc.sum += 0.2
        return vec4(acc.sum, 0.0, 0.0, 1.0)
  expected: |
    #version 460 core

    struct Accumulator {
        float sum;
        int count;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Accumulator acc = Accumulator(0.0, 0);
        for (int i = 0; i < 5; i += 1) {
            acc.sum += 0.2;
        }
        return vec4(acc.sum, 0.0, 0.0, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_multi_func
  python: |
    @dataclass
    class Vec2D:
        x: "float"
        y: "float"

    def length_squared(v: "Vec2D") -> "float":
        return v.x * v.x + v.y * v.y

    def scale(v: "Vec2D", s: "float") -> "Vec2D":
        return Vec2D(v.x * s, v.y * s)

    def shader(ctx: ShaderContext) -> vec4:
        v = Vec2D(3.0, 4.0)
        len2 = length_squared(v)
        scaled = scale(v, 0.5)
        return vec4(len2, scaled.x, scaled.y, 1.0)
  expected: |
    #version 460 core

    struct Vec2D {
        float x;
        float y;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    float length_squared(Vec2D v) {
        return v.x * v.x + v.y * v.y;
    }

    Vec2D scale(Vec2D v, float s) {
        return Vec2D(v.x * s, v.y * s);
    }

    vec4 shader() {
        Vec2D v = Vec2D(3.0, 4.0);
        float len2 = length_squared(v);
        Vec2D scaled = scale(v, 0.5);
        return vec4(len2, scaled.x, scaled.y, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: struct_deep_nested
  python: |
    @dataclass
    class Point:
        x: "float"
        y: "float"

    @dataclass
    class Line:
        start: "Point"
        end: "Point"

    @dataclass
    class Shape:
        line: "Line"
        color: "vec3"

    def shader(ctx: ShaderContext) -> vec4:
        s = Shape(Line(Point(0.0, 0.0), Point(1.0, 1.0)), vec3(1.0, 0.0, 0.0))
        return vec4(s.line.start.x, s.line.end.y, s.color.r, 1.0)
  expected: |
    #version 460 core

    struct Point {
        float x;
        float y;
    };

    struct Line {
        Point start;
        Point end;
    };

    struct Shape {
        Line line;
        vec3 color;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Shape s = Shape(Line(Point(0.0, 0.0), Point(1.0, 1.0)), vec3(1.0, 0.0, 0.0));
        return vec4(s.line.start.x, s.line.end.y, s.color.r, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: class_with_init
  python: |
    class Material:
        def __init__(self, color: "vec3", roughness: "float"):
            self.color = color
            self.roughness = roughness

    def shader(ctx: ShaderContext) -> vec4:
        mat = Material(vec3(1.0, 0.5, 0.0), 0.3)
        return vec4(mat.color * mat.roughness, 1.0)
  expected: |
    #version 460 core

    struct Material {
        vec3 color;
        float roughness;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    vec4 shader() {
        Material mat = Material(vec3(1.0, 0.5, 0.0), 0.3);
        return vec4(mat.color * mat.roughness, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: class_with_method
  python: |
    class Material:
        def __init__(self, color: "vec3", roughness: "float"):
            self.color = color
            self.roughness = roughness

        def brightness(self) -> "float":
            return (self.color.x + self.color.y + self.color.z) / 3.0

    def shader(ctx: ShaderContext) -> vec4:
        mat = Material(vec3(1.0, 0.5, 0.25), 0.5)
        b = mat.brightness()
        return vec4(b, b, b, 1.0)
  expected: |
    #version 460 core

    struct Material {
        vec3 color;
        float roughness;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    float Material_brightness(Material self) {
        return (self.color.x + self.color.y + self.color.z) / 3.0;
    }

    vec4 shader() {
        Material mat = Material(vec3(1.0, 0.5, 0.25), 0.5);
        float b = Material_brightness(mat);
        return vec4(b, b, b, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: class_method_with_params
  python: |
    class Vec2D:
        def __init__(self, x: "float", y: "float"):
            self.x = x
            self.y = y

        def scale(self, factor: "float") -> "Vec2D":
            return Vec2D(self.x * factor, self.y * factor)

        def add(self, other: "Vec2D") -> "Vec2D":
            return Vec2D(self.x + other.x, self.y + other.y)

    def shader(ctx: ShaderContext) -> vec4:
        a = Vec2D(1.0, 2.0)
        b = Vec2D(3.0, 4.0)
        scaled = a.scale(2.0)
        added = a.add(b)
        return vec4(scaled.x, scaled.y, added.x, 1.0)
  expected: |
    #version 460 core

    struct Vec2D {
        float x;
        float y;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    Vec2D Vec2D_scale(Vec2D self, float factor) {
        return Vec2D(self.x * factor, self.y * factor);
    }

    Vec2D Vec2D_add(Vec2D self, Vec2D other) {
        return Vec2D(self.x + other.x, self.y + other.y);
    }

    vec4 shader() {
        Vec2D a = Vec2D(1.0, 2.0);
        Vec2D b = Vec2D(3.0, 4.0);
        Vec2D scaled = Vec2D_scale(a, 2.0);
        Vec2D added = Vec2D_add(a, b);
        return vec4(scaled.x, scaled.y, added.x, 1.0);
    }

    void main() {
        fragColor = shader();
    }
- name: dataclass_with_method
  python: |
    @dataclass
    class Circle:
        center: "vec2"
        radius: "float"

        def contains(self, point: "vec2") -> "float":
            return length(point - self.center) - self.radius

    def shader(ctx: ShaderContext) -> vec4:
        c = Circle(vec2(0.5, 0.5), 0.3)
        d = c.contains(ctx.vs_uv)
        color = 1.0 if d < 0.0 else 0.0
        return vec4(color, color, color, 1.0)
  expected: |
    #version 460 core

    struct Circle {
        vec2 center;
        float radius;
    };

    in vec2 vs_uv;
    uniform float u_time;
    uniform vec2 u_resolution;
    uniform float u_aspect;
    uniform vec2 u_mouse_pos;
    uniform vec2 u_mouse_uv;
    out vec4 fragColor;

    float Circle_contains(Circle self, vec2 point) {
        return length(point - self.center) - self.radius;
    }

    vec4 shader() {
        Circle c = Circle(vec2(0.5, 0.5), 0.3);
        float d = Circle_contains(c, vs_uv);
        float color = d < 0.0 ? 1.0 : 0.0;
        return vec4(color, color, color, 1.0);
    }

    void main() {
        fragColor = shader();
    }
